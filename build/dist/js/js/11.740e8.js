webpackJsonp([11],{lrwy:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s("lC5x"),n=s.n(i),o=s("rVsN"),a=s.n(o),c=s("J0Oq"),l=s.n(c),r=s("3cXf"),d=s.n(r),p=s("gpPJ"),u=s("CKVb"),m=s("fvyU"),g=s("S9nr"),h=s("IXui"),f=s("o+C2"),v=s("jHHs"),b=s("Jp5S"),x=s("pxwZ"),P=s("8e4C"),S=s("7Eps"),T=s("9r/T"),I=s("/sQn"),w=s("VKKs"),y=s("ZpOu"),C=(b.a,p.a,u.a,m.a,g.a,h.a,f.a,S.a,v.a,I.a,y.a,"杭州市西湖区文三路90号"),q={directives:{TransferDom:b.a},name:"ESignature",components:{Cell:p.a,Group:u.a,XInput:m.a,Datetime:g.a,XButton:h.a,PopupPicker:f.a,BillCode:S.a,XDialog:v.a,AddImg:I.a,NoPermission:y.a},data:function(){return{role:"",hasPermission:!1,billCode:"",time:"",businessSceneAndSpecial:["请选择"],businessSceneAndSpecials:[["请选择","仓库","基站","移动签收","直运签收"],["请选择","地面","上楼","上山","其他"]],businessSceneValues:{"仓库":11,"基站":12,"移动签收":31,"直运签收":32},sceneLevelValues:{"地面":13,"上楼":14,"上山":15,"其他":16},comment:"",signType:["请选择"],signTypes:[["请选择","正常签收","异常签收","自提回单"]],signTypeValues:{"正常签收":1,"异常签收":2,"自提回单":30},abnormalType:["请选择"],abnormalTypes:[["请选择","货品不符","数量不符","包装损坏","其他"]],abnormalTypeValues:{"货品不符":3,"数量不符":4,"包装损坏":5,"其他":6},currentAddress:"",currentPos:"",receiptPos:"",receiptAddress:"",longitude:"",latitude:"",insideFence:"否",showDialog:!1,receiptPhotos:[],cargoPhotos:[],specScenePhotos:[],receiptImgIds:"",cargoImgIds:"",sceneImgIds:"",uploadDoneNum:0}},created:function(){this.$store.commit("updateTitle",P.h),this.time=this.common.getNowTime(),this.common.wxConfig(!1,["getLocation","chooseImage","previewImage","uploadImage","scanQRCode"]);var e=w.b.get(P.b);null!==e&&(this.role=e.role),"中通员工"!==this.role&&"司机"!==this.role&&"承运商"!==this.role||(this.hasPermission=!0)},mounted:function(){var e=document.documentElement.clientHeight;e>0&&(this.$refs.containerRef.style.height=e-160+"px")},methods:{timeChange:function(e){this.time=e},billCodeEvent:function(e){var t=this;if(console.log(e),this.billCode=e,""!==e){var s={order_code:e};this.$store.commit("updateLoading",!0),x.a.getOrderInfo(s).then(function(e){t.$store.commit("updateLoading",!1),1===e.code&&(t.receiptAddress=C,t.getGeocoder(t.receiptAddress).then(function(e){return t.receiptPos=e,t.getGeverseGeocoder(e),t.receiptPos}).then(function(e){t.getCurrentPos().then(function(s){console.log("curPos="+d()(s)),t.fenceJudge(e,s)})}))},function(e){t.$store.commit("updateLoading",!1)})}},fenceJudge:function(e,t){this.common.getDistance(e.lat,e.lng,t.lat,t.lng)<=P.f?this.insideFence="是":this.insideFence="否"},sceneChange:function(e){console.log(d()(e)),"请选择"!==e[0]&&"请选择"!==e[1]||(this.businessSceneAndSpecial=["请选择"])},showMapFence:function(){var e=this;this.$store.commit("updateLoading",!0),this.getCurrentPos().then(function(t){console.log("position="+d()(t)),e.currentPos=t,""!==e.receiptPos&&e.fenceJudge(e.receiptPos,t);var s={zoom:13,center:t,mapTypeId:qq.maps.MapTypeId.ROADMAP,scaleControl:!1,zoomControlOptions:{position:qq.maps.ControlPosition.RIGHT_BOTTOM}},i=new qq.maps.Map(document.getElementById("container"),s);e.showDialog=!0,Object(T.setTimeout)(function(){e.$store.commit("updateLoading",!1);new qq.maps.Marker({map:i,position:t}),new qq.maps.Label({position:t,offset:new qq.maps.Size(15,-30),map:i,content:"我的位置"});i.panTo(t),e.getGeverseGeocoder(t);var s=new qq.maps.Marker({map:i,position:e.receiptPos}),n=new qq.maps.Label({position:e.receiptPos,offset:new qq.maps.Size(15,-30),map:i,content:"交货地址: "+e.receiptAddress});new qq.maps.Circle({map:i,center:e.receiptPos,radius:P.f,strokeWeight:1});qq.maps.event.addListener(s,"click",function(e){n.setVisible(!0),n.getMap()?n.setMap(null):n.setMap(i)})},300)})},getCurrentPos:function(){var e=this;return l()(n.a.mark(function t(){return n.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new a.a(function(t,s){wx.getLocation({type:"gcj02",success:function(s){console.log("res="+d()(s)),e.longitude=s.longitude,e.latitude=s.latitude,e.currentPos=new qq.maps.LatLng(s.latitude,s.longitude),t(e.currentPos)}})}).catch(function(e){console.log(e),reject(e)}));case 1:case"end":return t.stop()}},t,e)}))()},getGeocoder:function(e){return new a.a(function(t,s){new qq.maps.Geocoder({complete:function(e){console.log(d()(e));var s=new qq.maps.LatLng(e.detail.location.lat,e.detail.location.lng);t(s)}}).getLocation(e)}).catch(function(e){console.log(e),reject(e)})},getGeverseGeocoder:function(e){var t=this;new qq.maps.Geocoder({complete:function(e){console.log(d()(e)),t.currentAddress=e.detail.address.substring(2)}}).getAddress(e)},getReceiptPhotos:function(e){this.receiptPhotos=e},getCargoPhotos:function(e){this.cargoPhotos=e},getSpecScenePhotos:function(e){this.specScenePhotos=e},complete:function(){if(""!==this.billCode)if(""!==this.currentAddress)if("请选择"!==this.signType[0])if("异常签收"!==this.signType[0]||"请选择"!==this.abnormalType[0])if(0!==this.receiptPhotos.length)if(0!==this.cargoPhotos.length)if("请选择"===this.businessSceneAndSpecial[0]||0!==this.specScenePhotos.length)if("否"===this.insideFence){var e=this;e.$vux.confirm.show({title:"电子签收",content:"所在位置在交货地点电子围栏范围之外, 确定签收 ?",onCancel:function(){},onConfirm:function(){e.receiptUploadToWeixin()}})}else this.receiptUploadToWeixin();else this.$vux.toast.text("请添加特殊场景照片 !","middle");else this.$vux.toast.text("请添加货物摆放照片 !","middle");else this.$vux.toast.text("请添加电子回单照片 !","middle");else this.$vux.toast.text("异常签收原因不能为空哦~","middle");else this.$vux.toast.text("签收类型不能为空哦~","middle");else this.$vux.toast.text("当前位置不能为空哦~, 请点击获取","middle");else this.$vux.toast.text("订单号不能为空哦~","middle")},receiptUploadToWeixin:function(){var e=this;wx.uploadImage({localId:e.receiptPhotos[0]+"",isShowProgressTips:1,success:function(t){e.receiptImgIds=t.serverId,e.$vux.toast.text("已上传1张","middle"),Object(T.setTimeout)(e.cargoUploadToWeixin(),300)}})},cargoUploadToWeixin:function(){var e=this;wx.uploadImage({localId:e.cargoPhotos[0]+"",isShowProgressTips:1,success:function(t){e.cargoImgIds=t.serverId,e.$vux.toast.text("已上传2张","middle"),e.specScenePhotos.length>0?Object(T.setTimeout)(e.uploadToWeixin(),300):e.postSignReceipt()}})},uploadToWeixin:function(){if(this.specScenePhotos.length===this.uploadDoneNum)this.uploadDoneNum=0,this.sceneImgIds=this.sceneImgIds.substring(0,this.sceneImgIds.length-1),this.postSignReceipt();else{var e=this;wx.uploadImage({localId:e.specScenePhotos[e.uploadDoneNum]+"",isShowProgressTips:1,success:function(t){var s=t.serverId;e.uploadDoneNum++;var i=e.uploadDoneNum+2;e.$vux.toast.text("已上传"+i+"张","middle"),e.sceneImgIds=""+e.sceneImgIds+s+",",Object(T.setTimeout)(e.uploadToWeixin(),300)}})}},postSignReceipt:function(){var e=this,t={bill_code:this.billCode,biz_scenename:this.businessSceneAndSpecial[0],biz_scene:this.businessSceneValues[this.businessSceneAndSpecial[0]],spec_scenename:this.businessSceneAndSpecial[1],spec_scene:this.sceneLevelValues[this.businessSceneAndSpecial[1]],comment:this.comment,address:this.currentAddress,longitude:this.longitude,latitude:this.latitude,time:this.time,sign_type:this.signTypeValues[this.signType[0]],sign_typename:this.signType[0],abnormal_type:this.abnormalTypeValues[this.abnormalType[0]],abnormal_typename:this.abnormalType[0],receipt_image:this.receiptImgIds,cargo_image:this.cargoImgIds,scene_images:this.sceneImgIds};P.c&&console.log("params="+d()(t)),this.$store.commit("updateLoading",!0),x.a.signReceipt(t).then(function(t){e.$store.commit("updateLoading",!1),0===t.code?e.$vux.toast.text("操作成功.","middle"):e.$vux.toast.text(t.message,"middle")},function(t){e.$store.commit("updateLoading",!1)})}}},_={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"eSignature"},[e.hasPermission?s("div",[s("group",{attrs:{"label-width":"4.5em","label-margin-right":"2em","label-align":"left"}},[s("bill-code",{on:{"on-billCode":e.billCodeEvent}}),e._v(" "),s("cell",{attrs:{title:"获取当前位置",value:e.currentAddress,"is-link":""},nativeOn:{click:function(t){return e.showMapFence(t)}}},[s("i",{staticClass:"fa fa-map-marker fa-lg fa-grey",attrs:{slot:"icon"},slot:"icon"})]),e._v(" "),s("cell",{attrs:{title:"是否在电子围栏范围内",value:e.insideFence}}),e._v(" "),s("datetime",{attrs:{format:"YYYY-MM-DD HH:mm","hour-list":e.hourList,"minute-list":e.minuteList,title:"选择时间"},on:{"on-change":e.timeChange},model:{value:e.time,callback:function(t){e.time=t},expression:"time"}})],1),e._v(" "),s("group",{attrs:{title:"电子回单","label-width":"5.5em","label-margin-right":"2em"}},[s("popup-picker",{attrs:{title:"签收类型","popup-title":"签收类型",data:e.signTypes,placeholder:"请选择"},on:{"on-change":e.check},model:{value:e.signType,callback:function(t){e.signType=t},expression:"signType"}}),e._v(" "),s("popup-picker",{attrs:{title:"异常原因","popup-title":"异常原因",data:e.abnormalTypes,placeholder:"请选择"},on:{"on-change":e.check},model:{value:e.abnormalType,callback:function(t){e.abnormalType=t},expression:"abnormalType"}}),e._v(" "),s("add-img",{attrs:{count:1},on:{"on-getPhotos":e.getReceiptPhotos}})],1),e._v(" "),s("group",{attrs:{title:"货物摆放照片","label-width":"5.5em","label-margin-right":"2em"}},[s("add-img",{attrs:{count:1},on:{"on-getPhotos":e.getCargoPhotos}})],1),e._v(" "),s("group",{attrs:{title:"特殊场景(可选)","label-width":"120px","label-margin-right":"2em"}},[s("popup-picker",{attrs:{title:"业务场景 场景难度","popup-title":"业务场景  场景难度",data:e.businessSceneAndSpecials,placeholder:"请选择"},on:{"on-change":e.sceneChange},model:{value:e.businessSceneAndSpecial,callback:function(t){e.businessSceneAndSpecial=t},expression:"businessSceneAndSpecial"}}),e._v(" "),"其他"===e.businessSceneAndSpecial[1]?s("x-input",{attrs:{title:"补充信息",placeholder:"输入补充信息","placeholder-align":"right","text-align":"right"},model:{value:e.comment,callback:function(t){e.comment=t},expression:"comment"}}):e._e(),e._v(" "),s("add-img",{attrs:{count:9},on:{"on-getPhotos":e.getSpecScenePhotos}})],1),e._v(" "),s("div",{staticStyle:{padding:"25px"}},[s("x-button",{attrs:{type:"primary","action-type":"submit"},nativeOn:{click:function(t){return e.complete(t)}}},[e._v("完成")])],1),e._v(" "),s("div",{directives:[{name:"transfer-dom",rawName:"v-transfer-dom"}]},[s("x-dialog",{staticClass:"dialog-demo",model:{value:e.showDialog,callback:function(t){e.showDialog=t},expression:"showDialog"}},[s("div",{staticClass:"img-box"},[s("div",{ref:"containerRef",attrs:{id:"container"}})]),e._v(" "),s("div",{on:{click:function(t){e.showDialog=!1}}},[s("span",{staticClass:"vux-close"})])])],1)],1):s("no-permission")],1)},staticRenderFns:[]};var A=s("C7Lr")(q,_,!1,function(e){s("nVqC")},null,null);t.default=A.exports},nVqC:function(e,t){}});